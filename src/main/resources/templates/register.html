<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{layout/main}">
<head>
    <title>Register</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-5">
                    <div class="card shadow">
                        <div class="card-body p-5">
                            <h2 class="text-center mb-4">Create Account</h2>
                            
                            <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}"></div>
                            
                            <form method="post" th:action="@{/register}">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" name="username" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="displayName" class="form-label">Display Name</label>
                                    <input type="text" class="form-control" id="displayName" name="displayName" required>
                                </div>
                                
                                <div class="mb-4">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" name="password" required minlength="6">
                                </div>
                                
                                <button type="submit" class="btn btn-primary w-100">Create Account</button>
                            </form>
                            
                            <div th:if="false" id="passkeyRegistration">
                                <button id="registerPasskey" class="btn btn-primary w-100 btn-lg">
                                    üîê Register Passkey
                                </button>
                                <p class="text-center text-muted mt-3">
                                    <small>You'll need to register a passkey to sign in</small>
                                </p>
                            </div>
                            
                            <div class="text-center mt-3">
                                <a href="/login" th:href="@{/login}">Already have an account? Sign in</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script th:if="${success}">
            const username = /*[[${username}]]*/ '';
            const registerButton = document.getElementById('registerPasskey');
            
            registerButton.addEventListener('click', async () => {
                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content ||
                                    document.querySelector('input[name="_csrf"]')?.value;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
                    
                    // Request registration options from server
                    const optionsResponse = await fetch('/webauthn/register/options', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        }
                    });
                    
                    if (!optionsResponse.ok) {
                        throw new Error('Failed to get registration options');
                    }
                    
                    const options = await optionsResponse.json();
                    
                    // Convert base64url strings to Uint8Array
                    options.challenge = base64urlToUint8Array(options.challenge);
                    options.user.id = base64urlToUint8Array(options.user.id);
                    if (options.excludeCredentials) {
                        options.excludeCredentials = options.excludeCredentials.map(cred => ({
                            ...cred,
                            id: base64urlToUint8Array(cred.id)
                        }));
                    }
                    
                    // Create credential
                    const credential = await navigator.credentials.create({
                        publicKey: options
                    });
                    
                    // Prepare credential for server
                    const credentialJSON = {
                        publicKey: {
                            credential: {
                                id: credential.id,
                                rawId: uint8ArrayToBase64url(new Uint8Array(credential.rawId)),
                                response: {
                                    attestationObject: uint8ArrayToBase64url(new Uint8Array(credential.response.attestationObject)),
                                    clientDataJSON: uint8ArrayToBase64url(new Uint8Array(credential.response.clientDataJSON)),
                                    transports: credential.response.getTransports ? credential.response.getTransports() : []
                                },
                                type: credential.type,
                                clientExtensionResults: credential.getClientExtensionResults(),
                                authenticatorAttachment: credential.authenticatorAttachment
                            },
                            label: 'My Passkey'
                        }
                    };
                    
                    // Send credential to server
                    const registerResponse = await fetch('/webauthn/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify(credentialJSON)
                    });
                    
                    if (registerResponse.ok) {
                        alert('Passkey registered successfully!');
                        window.location.href = '/login';
                    } else {
                        alert('Registration failed');
                    }
                    
                } catch (error) {
                    console.error('Passkey registration failed:', error);
                    alert('Registration failed: ' + error.message);
                }
            });
            
            function base64urlToUint8Array(base64url) {
                const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                return bytes;
            }
            
            function uint8ArrayToBase64url(uint8Array) {
                let binary = '';
                const len = uint8Array.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(uint8Array[i]);
                }
                return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
            }
        </script>
    </div>
</body>
</html>
