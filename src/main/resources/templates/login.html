<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      layout:decorate="~{layout/main}">
<head>
    <title>Login</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-5">
                    <div class="card shadow">
                        <div class="card-body p-5">
                            <h2 class="text-center mb-4">Sign In</h2>
                            
                            <div th:if="${param.error}" class="alert alert-danger" role="alert">
                                Invalid credentials
                            </div>
                            
                            <div th:if="${param.logout}" class="alert alert-success" role="alert">
                                You have been logged out
                            </div>
                            
                            <div th:if="${param.registered}" class="alert alert-success" role="alert">
                                Registration successful! Please log in.
                            </div>
                            
                            <!-- Username/Password Login -->
                            <form method="post" th:action="@{/login}" class="mb-4">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" name="username" required autofocus>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                </div>
                                
                                <button type="submit" class="btn btn-primary w-100">Sign In</button>
                            </form>
                            
                            <div class="text-center mb-3">
                                <span class="text-muted">OR</span>
                            </div>
                            
                            <!-- Passkey Sign In -->
                            <div class="mb-4">
                                <button id="passkeySignIn" class="btn btn-primary w-100 btn-lg">
                                    üîê Sign in with Passkey
                                </button>
                            </div>
                            
                            <div class="text-center">
                                <p class="text-muted mb-0">Don't have an account?</p>
                                <a href="/register" th:href="@{/register}" class="btn btn-link">Create Account</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            const passkeySignInButton = document.getElementById('passkeySignIn');
            
            passkeySignInButton.addEventListener('click', async () => {
                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('meta[name="_csrf"]')?.content ||
                                    document.querySelector('input[name="_csrf"]')?.value;
                    const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';
                    
                    // Request authentication options from server
                    const optionsResponse = await fetch('/webauthn/authenticate/options', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        }
                    });
                    
                    if (!optionsResponse.ok) {
                        throw new Error('Failed to get authentication options');
                    }
                    
                    const options = await optionsResponse.json();
                    
                    // Convert base64url strings to Uint8Array
                    options.challenge = base64urlToUint8Array(options.challenge);
                    if (options.allowCredentials) {
                        options.allowCredentials = options.allowCredentials.map(cred => ({
                            ...cred,
                            id: base64urlToUint8Array(cred.id)
                        }));
                    }
                    
                    // Get credential from authenticator
                    const credential = await navigator.credentials.get({
                        publicKey: options
                    });
                    
                    // Prepare credential for server (Spring Security format)
                    const credentialJSON = {
                        id: credential.id,
                        rawId: uint8ArrayToBase64url(new Uint8Array(credential.rawId)),
                        response: {
                            authenticatorData: uint8ArrayToBase64url(new Uint8Array(credential.response.authenticatorData)),
                            clientDataJSON: uint8ArrayToBase64url(new Uint8Array(credential.response.clientDataJSON)),
                            signature: uint8ArrayToBase64url(new Uint8Array(credential.response.signature)),
                            userHandle: credential.response.userHandle ? uint8ArrayToBase64url(new Uint8Array(credential.response.userHandle)) : null
                        },
                        type: credential.type,
                        clientExtensionResults: {}
                    };
                    
                    // Log for debugging
                    console.log('Sending authentication credential:', credentialJSON);
                    
                    // Send credential to server
                    const loginResponse = await fetch('/login/webauthn', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            [csrfHeader]: csrfToken
                        },
                        body: JSON.stringify(credentialJSON)
                    });
                    
                    if (loginResponse.ok) {
                        window.location.href = '/dashboard';
                    } else {
                        const errorText = await loginResponse.text();
                        console.error('Authentication failed:', errorText);
                        alert('Authentication failed. Check console for details.');
                    }
                    
                } catch (error) {
                    console.error('Passkey authentication failed:', error);
                    alert('Authentication failed: ' + error.message);
                }
            });
            
            function base64urlToUint8Array(base64url) {
                const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
                const binary = atob(base64);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                return bytes;
            }
            
            function uint8ArrayToBase64url(uint8Array) {
                let binary = '';
                const len = uint8Array.byteLength;
                for (let i = 0; i < len; i++) {
                    binary += String.fromCharCode(uint8Array[i]);
                }
                return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
            }
        </script>
    </div>
</body>
</html>
